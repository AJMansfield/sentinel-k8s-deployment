apiVersion: v1
kind: Namespace
metadata:
  name: samba-honeypot
  labels:
    app: samba-honeypot
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: samba-pvc
  namespace: samba-honeypot
  labels:
    app: samba-honeypot
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 100Mi
---
apiVersion: "k8s.cni.cncf.io/v1"
kind: NetworkAttachmentDefinition
metadata:
  name: macvlan-conf
  namespace: samba-honeypot
  labels:
    app: samba-honeypot
spec:
  config: '{
      "cniVersion": "0.3.0",
      "type": "macvlan",
      "mode": "bridge",
      "master": "eno1",
      "ipam": {
        "type": "dhcp",
        "provide": [
          {
            "option": "host-name",
            "value": "fileserver"
          }
        ]
      }
    }'
---
# Configuration for the samba domain member pod.
apiVersion: v1
kind: ConfigMap
metadata:
  name: samba-container-config
  namespace: samba-honeypot
  labels:
    app: samba-honeypot
data:
  config.json: |
    {
      "samba-container-config": "v0",
      "configs": {
        "demo": {
          "shares": [
            "share"
          ],
          "globals": [
            "default"
          ],
          "instance_name": "SAMBA"
        }
      },
      "shares": {
        "share": {
          "options": {
            "path": "/share",
            "public": "yes",
            "browseable": "yes",
            "read only": "no",
            "guest ok": "yes",
            "writeable": "yes",
            "create mask": "666",
            "directory mask": "777",
            "force user": "sambauser",
            "force group": "sambauser"
          }
        }
      },
      "globals": {
        "default": {
          "options": {
            "workgroup": "WORKGROUP",
            "security": "user",
            "map to guest": "Bad User",
            "guest account": "sambauser"
          }
        }
      },
      "users": {
        "all_entries": [
          {
            "name": "sambauser",
            "password": "samba"
          }
        ]
      },
      "_footer": 1
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: samba
  namespace: samba-honeypot
  labels:
    app: samba-honeypot
spec:
  replicas: 1
  selector:
    matchLabels:
      app: samba-honeypot
  template:
    metadata:
      labels:
        app: samba-honeypot
      annotations:
        k8s.v1.cni.cncf.io/networks: macvlan-conf
    spec:
      shareProcessNamespace: true
      containers:
        - image: quay.io/samba.org/samba-server:latest
          name: smb
          command:
          - "samba-container"
          - "run"
          - "smbd"
          ports:
          - containerPort: 445
            hostPort: 455
            protocol: TCP
            name: "smb"
          securityContext:
            allowPrivilegeEscalation: true
          volumeMounts:
          - mountPath: "/share"
            name: samba-sharedir
          - mountPath: "/etc/samba-container"
            name: samba-container-config
          - mountPath: "/var/lib/samba"
            name: samba-state-dir
          - mountPath: "/run/samba/winbindd"
            name: samba-sockets-dir
        - image: quay.io/samba.org/samba-server:latest
          name: winbind
          command:
          - "samba-container"
          - "run"
          - "winbindd"
          securityContext:
            allowPrivilegeEscalation: true
          volumeMounts:
          - mountPath: "/etc/samba-container"
            name: samba-container-config
          - mountPath: "/var/lib/samba"
            name: samba-state-dir
          - mountPath: "/run/samba/winbindd"
            name: samba-sockets-dir
      initContainers:
        - image: quay.io/samba.org/samba-server:latest
          name: init
          args:
          - "init"
          securityContext:
            allowPrivilegeEscalation: true
          volumeMounts:
          - mountPath: "/etc/samba-container"
            name: samba-container-config
          - mountPath: "/var/lib/samba"
            name: samba-state-dir
      volumes:
      - configMap:
          name: samba-container-config
        name: samba-container-config
      - emptyDir:
          medium: Memory
        name: samba-sockets-dir
      - emptyDir: {}
        name: samba-state-dir
    # Comment out the section below to skip using a PVC for the share
      - persistentVolumeClaim:
          claimName: samba-pvc
        name: samba-sharedir
    # Uncomment the section below to use an empty dir for the share
    #  - emptyDir:
    #      medium: Memory
    #    name: samba-sharedir