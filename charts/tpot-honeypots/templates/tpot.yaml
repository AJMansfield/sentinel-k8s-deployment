{{- range $potname, $params := .Values.services }}

{{- $replicas := $params.replicas | default 1 }}
{{- range $rep, $rep_ := until ( int $replicas ) }}

{{- /* Pick random hostname from list, and printf in a random string if it can accept one. */}}
{{- $hostnameList := get $.Values.hostnameLists $params.hostnameList }}
{{- $hostname := index $hostnameList ( mod ( randNumeric 5 ) ( len $hostnameList ) ) }} 
{{- $hostname := printf $hostname ( randAlphaNum 5 ) ( randNumeric 3 ) }}
{{- $hostname := regexReplaceAll "%!.*" $hostname "" }}
{{- $hostname := regexReplaceAll ".*\\[" $hostname "" }}
{{- $hostname := regexReplaceAll "\\].*" $hostname "" }}

apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ $.Release.Name }}-{{ $potname }}-{{ $rep }}
  namespace: {{ $.Release.Namespace }}
  labels:
    app: {{ $.Release.Name }}
  annotations:
    hostname: {{ $hostname }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: {{ $.Release.Name }}
  template:
    metadata:
      labels:
        app: {{ $.Release.Name }}
      annotations:
        k8s.v1.cni.cncf.io/networks: {{ $.Values.networks }}
        hostname: {{ $hostname }}
    spec:
      hostname: {{ $hostname | lower}}
      containers:
      - name: {{ $potname }}
        image: {{ $params.image }}
        volumeMounts:
        - name: logs
          mountPath: "{{ $params.logDir }}"
          subPath: "{{ $potname }}-{{ $rep }}"
        {{- range $mnt_name, $mnt_path := $params.dirs }}
        - name: tmp
          mountPath: "{{ $mnt_path }}"
          subPath: "{{ $mnt_name }}"
        {{- end }}
        securityContext:
          allowPrivilegeEscalation: true
          capabilities:
            add: ["NET_BIND_SERVICE", "NET_BROADCAST", "NET_ADMIN"]

      - name: dhcp
        image: busybox
        command: [
          "udhcpc",
          "-i", "net1", # Interface to use
          "-B", # Request broadcast replies (so everyone sees us)
          "-T", "5", # Pause between packets
          "-R", # Release IP on exit
          "-f", # Run in foreground
          "-a", # Validate offerred address with ARP ping (so everyone sees us)
          "-O", "12", # request Host Name
          "-O", "15", # request Domain Name
          "-O", "42", # request NTP Servers
          "-O", "119", # request Doman Search
          "-O", "120", # request SIP Servers
          "-x", "hostname:{{ $hostname }}", # provide option 22
          "-F", "{{ $hostname }}", # Ask server to update DNS mapping 
        ]
        volumeMounts:
        - name: udhcpc-scripts
          mountPath: "/usr/share/udhcpc"
        securityContext:
          allowPrivilegeEscalation: true
          capabilities:
            add: ["NET_BIND_SERVICE", "NET_BROADCAST", "NET_ADMIN"]

      volumes:
      - name: logs
        persistentVolumeClaim:
          claimName: "{{ $.Release.Name }}-logs"
      - name: tmp
        emptyDir: {}
      - name: udhcpc-scripts
        configMap:
          name: {{ $.Release.Name }}-udhcpc-scripts
          defaultMode: 0700
---
{{- end }}
{{- end }}